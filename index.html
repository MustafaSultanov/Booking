<!DOCTYPE html>
<html lang="ky">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–í–æ–ª–µ–π–±–æ–ª –ó–∞–ª—ã</title>
		<style>
			/* --- –°–¢–ò–õ–î–ï–† (”®–∑–≥”©—Ä—Ç“Ø“Ø—Å“Ø–∑ –∫–∞–ª–¥—ã) --- */
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Inter", sans-serif;
				background: #f1f5f9;
				color: #1e293b;
			}
			#home-page {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				height: 100vh;
				text-align: center;
			}
			.welcome-text {
				font-size: 32px;
				font-weight: 800;
				color: #0f172a;
				margin-bottom: 20px;
			}
			#admin-page {
				display: none;
				padding: 15px;
			}
			.container {
				max-width: 1000px;
				margin: 0 auto;
			}
			.header {
				background: white;
				border-radius: 20px;
				padding: 20px;
				margin-bottom: 20px;
				text-align: center;
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			}
			.back-btn {
				margin-bottom: 10px;
				display: inline-block;
				color: #64748b;
				text-decoration: none;
				font-size: 14px;
			}
			.sync-status {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 6px 12px;
				border-radius: 50px;
				font-size: 12px;
				margin-top: 10px;
			}
			.success {
				background: #dcfce7;
				color: #166534;
			}
			.syncing {
				background: #fef9c3;
				color: #854d0e;
			}
			.week-nav {
				display: flex;
				justify-content: space-between;
				align-items: center;
				background: white;
				border-radius: 15px;
				padding: 15px;
				margin-bottom: 20px;
			}
			.nav-btn {
				background: #3b82f6;
				color: white;
				border: none;
				padding: 8px 15px;
				border-radius: 10px;
				cursor: pointer;
			}
			.days-grid {
				display: grid;
				gap: 20px;
			}
			.day-card {
				background: white;
				border-radius: 18px;
				padding: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}
			.day-header {
				display: flex;
				justify-content: space-between;
				border-bottom: 2px solid #f8fafc;
				padding-bottom: 10px;
				margin-bottom: 15px;
			}
			.time-slots {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
				gap: 10px;
			}
			.time-slot {
				padding: 10px 5px;
				border-radius: 10px;
				text-align: center;
				cursor: pointer;
				border: 1px solid #e2e8f0;
				font-weight: 600;
				font-size: 13px;
			}
			.available {
				color: #16a34a;
				border-color: #bbf7d0;
			}
			.booked {
				background: #fee2e2;
				color: #dc2626;
				border-color: #fecaca;
				cursor: not-allowed;
			}
			.past {
				background: #f8fafc;
				color: #94a3b8;
				cursor: not-allowed;
			}
			.booked-section {
				margin-top: 30px;
				background: white;
				padding: 20px;
				border-radius: 20px;
			}
			.booked-item {
				display: flex;
				justify-content: space-between;
				padding: 12px;
				border-bottom: 1px solid #f1f5f9;
				align-items: center;
			}
			.cancel-btn {
				background: #ef4444;
				color: white;
				border: none;
				padding: 6px 12px;
				border-radius: 6px;
				cursor: pointer;
			}
			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.6);
				align-items: center;
				justify-content: center;
				z-index: 1000;
			}
			.modal.active {
				display: flex;
			}
			.modal-content {
				background: white;
				padding: 25px;
				border-radius: 20px;
				width: 90%;
				max-width: 320px;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<div id="home-page">
			<h1 class="welcome-text">–ê—Å—Å–∞–ª–∞–º—É –∞–ª–µ–π–∫—É–º!</h1>
			<p style="color: #64748b; margin-bottom: 30px">
				–í–æ–ª–µ–π–±–æ–ª –∑–∞–ª—ã–Ω—ã–Ω –±—Ä–æ–Ω–¥–æ–æ —Å–∏—Å—Ç–µ–º–∞—Å—ã–Ω–∞ –∫–æ—à –∫–µ–ª–∏“£–∏–∑.
			</p>
		</div>

		<div id="admin-page">
			<div class="container">
				<a href="#" class="back-btn">‚Üê –ë–∞—à–∫—ã–≥–∞ –∫–∞–π—Ç</a>
				<div class="header">
					<h1>üèê –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h1>
					<div class="sync-status" id="syncStatus">
						<span id="syncText">–ñ“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...</span>
					</div>
				</div>

				<div class="week-nav">
					<button class="nav-btn" onclick="changeWeek(-1)">‚Üê</button>
					<div id="weekInfo" style="font-weight: bold"></div>
					<button class="nav-btn" onclick="changeWeek(1)">‚Üí</button>
				</div>

				<div class="days-grid" id="daysGrid"></div>

				<div class="booked-section">
					<h2 style="margin-bottom: 15px">üìÖ –ë–∞—Ä–¥—ã–∫ –±—Ä–æ–Ω–¥–æ—Ä</h2>
					<div id="bookedList"></div>
				</div>
			</div>
		</div>

		<div class="modal" id="bookingModal">
			<div class="modal-content">
				<h3>–ë—Ä–æ–Ω–¥–æ–æ</h3>
				<p
					id="modalText"
					style="margin: 15px 0; color: #64748b; font-size: 14px"></p>
				<div style="display: flex; gap: 10px">
					<button
						class="nav-btn"
						id="confirmBtn"
						style="flex: 1"
						onclick="confirmBooking()">
						–û–æ–±–∞
					</button>
					<button
						onclick="closeModal()"
						style="flex: 1; border: none; border-radius: 10px; cursor: pointer">
						–ñ–æ–∫
					</button>
				</div>
			</div>
		</div>

		<script>
			const API_URL =
				"https://api-crud.elcho.dev/api/v1/d8281-f9a3a-6931f/booking";
			let bookedSlots = [];
			let currentWeekOffset = 0;
			let selectedSlot = null;
			const dayNames = [
				"–î“Ø–π—à”©–º–±“Ø",
				"–®–µ–π—à–µ–º–±–∏",
				"–®–∞—Ä—à–µ–º–±–∏",
				"–ë–µ–π—à–µ–º–±–∏",
				"–ñ—É–º–∞",
				"–ò—à–µ–º–±–∏",
				"–ñ–µ–∫—à–µ–º–±–∏",
			];

			function handleRoute() {
				const path = window.location.hash;
				if (path === "#/admin") {
					document.getElementById("home-page").style.display = "none";
					document.getElementById("admin-page").style.display = "block";
					loadData();
				} else {
					document.getElementById("home-page").style.display = "flex";
					document.getElementById("admin-page").style.display = "none";
				}
			}
			window.addEventListener("hashchange", handleRoute);
			window.addEventListener("load", handleRoute);

			function updateStatus(type, text) {
				const el = document.getElementById("syncStatus");
				if (el) {
					el.className = "sync-status " + type;
					document.getElementById("syncText").textContent = text;
				}
			}

			async function loadData() {
				try {
					updateStatus("syncing", "–ñ–∞“£—ã–ª–∞–Ω—É—É–¥–∞...");
					const res = await fetch(API_URL);
					const data = await res.json();
					bookedSlots = (Array.isArray(data) ? data : data.data || []).sort(
						(a, b) => a.date.localeCompare(b.date) || a.start - b.start
					);
					updateStatus("success", "‚óè –û–Ω–ª–∞–π–Ω");
					render();
				} catch (e) {
					updateStatus("offline", "‚óã –ö–∞—Ç–∞");
				}
			}

			async function confirmBooking() {
				if (!selectedSlot) return;
				try {
					await fetch(API_URL, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							date: selectedSlot.date,
							start: selectedSlot.hour,
							end: selectedSlot.hour + 1,
						}),
					});
					closeModal();
					loadData();
				} catch (e) {
					alert("–ö–∞—Ç–∞!");
				}
			}

			async function deleteBooking(id) {
				if (confirm("”®—á“Ø—Ä”©—Å“Ø–∑–±“Ø?")) {
					await fetch(`${API_URL}/${id}`, { method: "DELETE" });
					loadData();
				}
			}

			// –°–∞–∞—Ç—Ç—ã —Ñ–æ—Ä–º–∞—Ç—Ç–æ–æ (24:00 -> 00:00, 25:00 -> 01:00)
			function formatHour(h) {
				if (h === 24) return "00:00";
				if (h > 24) return `0${h - 24}:00`;
				return `${h}:00`;
			}

			function render() {
				const now = new Date();
				const startOfWeek = new Date(now);
				startOfWeek.setDate(
					now.getDate() +
						((now.getDay() === 0 ? -6 : 1) - now.getDay()) +
						currentWeekOffset * 7
				);

				const dates = Array.from({ length: 7 }, (_, i) => {
					const d = new Date(startOfWeek);
					d.setDate(startOfWeek.getDate() + i);
					return d;
				});

				document.getElementById(
					"weekInfo"
				).textContent = `${dates[0].getDate()}.${
					dates[0].getMonth() + 1
				} - ${dates[6].getDate()}.${dates[6].getMonth() + 1}`;
				const grid = document.getElementById("daysGrid");
				grid.innerHTML = "";

				dates.forEach((date, idx) => {
					const dateStr = date.toISOString().split("T")[0];
					let slotsHtml = "";

					// –°–ê–ê–¢–¢–ê–†: 09:00–¥”©–Ω —Ç“Ø–Ω–∫“Ø 02:00–≥”© —á–µ–π–∏–Ω (26–≥–∞ —á–µ–π–∏–Ω)
					for (let h = 9; h < 26; h++) {
						const isBooked = bookedSlots.find(
							(s) => s.date === dateStr && parseInt(s.start) === h
						);

						// ”®—Ç–∫”©–Ω —É–±–∞–∫—ã—Ç—Ç—ã —Ç–µ–∫—à–µ—Ä“Ø“Ø
						const slotTime = new Date(date);
						slotTime.setHours(h, 0, 0);
						const isPast = slotTime < now;

						let cls = isBooked ? "booked" : isPast ? "past" : "available";
						let act =
							!isBooked && !isPast
								? `onclick="openModal('${dateStr}', ${h})"`
								: "";

						slotsHtml += `<div class="time-slot ${cls}" ${act}>${formatHour(
							h
						)}</div>`;
					}
					grid.innerHTML += `
            <div class="day-card">
              <div class="day-header"><strong>${
								dayNames[idx]
							}</strong> <span>${date.getDate()}.${
						date.getMonth() + 1
					}</span></div>
              <div class="time-slots">${slotsHtml}</div>
            </div>`;
				});

				document.getElementById("bookedList").innerHTML =
					bookedSlots
						.map(
							(s) => `
          <div class="booked-item">
            <div><b>${s.date}</b> | ${formatHour(parseInt(s.start))}</div>
            <button class="cancel-btn" onclick="deleteBooking('${
							s._id || s.id
						}')">”®—á“Ø—Ä“Ø“Ø</button>
          </div>`
						)
						.join("") || "–¢–∏–∑–º–µ –±–æ—à";
			}

			function openModal(date, hour) {
				selectedSlot = { date, hour };
				document.getElementById(
					"modalText"
				).textContent = `${date} –∫“Ø–Ω“Ø —Å–∞–∞—Ç ${formatHour(hour)}–≥–æ –±—Ä–æ–Ω–¥–æ–π—Å—É–∑–±—É?`;
				document.getElementById("bookingModal").classList.add("active");
			}
			function closeModal() {
				document.getElementById("bookingModal").classList.remove("active");
			}
			function changeWeek(dir) {
				currentWeekOffset += dir;
				render();
			}
		</script>
	</body>
</html>
