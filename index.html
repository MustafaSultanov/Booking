<!DOCTYPE html>
<html lang="ky">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–í–∞–ª–µ–π–±–æ–ª –ó–∞–ª—ã - –ë—Ä–æ–Ω–¥–æ–æ –°–∏—Å—Ç–µ–º–∞—Å—ã</title>
		<style>
			/* –°–∏–∑–¥–∏–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª–¥—É—É —Å—Ç–∏–ª–¥–µ—Ä–∏“£–∏–∑ —Å–∞–∫—Ç–∞–ª–¥—ã */
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Inter", sans-serif;
				background: #f8fafc;
				padding: 20px;
				color: #1e293b;
			}
			.container {
				max-width: 1200px;
				margin: 0 auto;
			}
			.header {
				background: white;
				border-radius: 16px;
				padding: 24px;
				margin-bottom: 24px;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
			}
			.sync-status {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 6px 12px;
				border-radius: 6px;
				font-size: 13px;
				margin-top: 8px;
			}
			.success {
				background: #f0fdf4;
				color: #166534;
				border: 1px solid #bbf7d0;
			}
			.syncing {
				background: #fef3c7;
				color: #92400e;
				border: 1px solid #fde68a;
			}
			.offline {
				background: #fee2e2;
				color: #991b1b;
				border: 1px solid #fecaca;
			}
			.week-nav {
				display: flex;
				justify-content: space-between;
				align-items: center;
				background: white;
				border-radius: 12px;
				padding: 15px 20px;
				margin-bottom: 24px;
			}
			.nav-btn {
				background: #f1f5f9;
				border: none;
				padding: 10px 15px;
				border-radius: 8px;
				cursor: pointer;
			}
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 16px;
				margin-bottom: 24px;
			}
			.stat-card {
				background: white;
				padding: 20px;
				border-radius: 12px;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
			}
			.stat-value {
				font-size: 24px;
				font-weight: 700;
			}
			.days-grid {
				display: grid;
				gap: 20px;
			}
			.day-card {
				background: white;
				border-radius: 12px;
				padding: 20px;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
			}
			.day-header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 15px;
				border-bottom: 1px solid #f1f5f9;
				padding-bottom: 10px;
			}
			.time-slots {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
				gap: 8px;
			}
			.time-slot {
				padding: 10px;
				border-radius: 8px;
				text-align: center;
				cursor: pointer;
				border: 1px solid #e2e8f0;
				font-weight: 500;
			}
			.available {
				background: #f0fdf4;
				color: #166534;
			}
			.booked {
				background: #fef2f2;
				color: #991b1b;
				cursor: not-allowed;
			}
			.past {
				background: #f1f5f9;
				color: #94a3b8;
				cursor: not-allowed;
			}
			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				align-items: center;
				justify-content: center;
				z-index: 100;
			}
			.modal.active {
				display: flex;
			}
			.modal-content {
				background: white;
				padding: 30px;
				border-radius: 12px;
				width: 90%;
				max-width: 400px;
			}
			.modal-buttons {
				display: flex;
				gap: 10px;
				margin-top: 20px;
			}
			.modal-btn {
				flex: 1;
				padding: 10px;
				border-radius: 6px;
				border: none;
				cursor: pointer;
				font-weight: 600;
			}
			.confirm {
				background: #16a34a;
				color: white;
			}
			.cancel {
				background: #f1f5f9;
			}
			.booked-section {
				margin-top: 30px;
				background: white;
				padding: 20px;
				border-radius: 12px;
			}
			.booked-item {
				display: flex;
				justify-content: space-between;
				padding: 10px;
				border-bottom: 1px solid #eee;
				align-items: center;
			}
			.cancel-btn {
				background: #dc2626;
				color: white;
				border: none;
				padding: 5px 10px;
				border-radius: 4px;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>üèê –í–∞–ª–µ–π–±–æ–ª –ó–∞–ª—ã</h1>
				<div class="sync-status" id="syncStatus">
					<span id="syncText">–ñ“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...</span>
				</div>
			</div>

			<div id="mainContent">
				<div class="week-nav">
					<button class="nav-btn" onclick="changeWeek(-1)">‚Üê –ú—É—Ä—É–Ω–∫—É</button>
					<div id="weekInfo" style="font-weight: bold"></div>
					<button class="nav-btn" onclick="changeWeek(1)">–ö–∏–π–∏–Ω–∫–∏ ‚Üí</button>
				</div>

				<div class="stats-grid" id="statsGrid"></div>
				<div class="days-grid" id="daysGrid"></div>

				<div class="booked-section">
					<h2>–°–∏–∑–¥–∏–Ω –±—Ä–æ–Ω–¥–æ—Ä—É“£—É–∑ (–ñ–∞–ª–ø—ã —Ç–∏–∑–º–µ)</h2>
					<div id="bookedList"></div>
				</div>
			</div>
		</div>

		<div class="modal" id="bookingModal">
			<div class="modal-content">
				<h2>–ë—Ä–æ–Ω–¥–æ–æ</h2>
				<p id="modalText"></p>
				<div class="modal-buttons">
					<button
						class="modal-btn confirm"
						id="confirmBtn"
						onclick="confirmBooking()">
						–´—Ä–∞—Å—Ç–æ–æ
					</button>
					<button class="modal-btn cancel" onclick="closeModal()">–ñ–æ–∫</button>
				</div>
			</div>
		</div>

		<script>
			const API_URL =
				"https://api-crud.elcho.dev/api/v1/d8281-f9a3a-6931f/booking";

			let bookedSlots = [];
			let selectedSlot = null;
			let currentWeekOffset = 0;
			const dayNames = [
				"–î“Ø–π—à”©–º–±“Ø",
				"–®–µ–π—à–µ–º–±–∏",
				"–®–∞—Ä—à–µ–º–±–∏",
				"–ë–µ–π—à–µ–º–±–∏",
				"–ñ—É–º–∞",
				"–ò—à–µ–º–±–∏",
				"–ñ–µ–∫—à–µ–º–±–∏",
			];

			function updateStatus(type, text) {
				const el = document.getElementById("syncStatus");
				el.className = "sync-status " + type;
				document.getElementById("syncText").textContent = text;
			}

			// API –∞—Ä–∫—ã–ª—É—É –º–∞–∞–ª—ã–º–∞—Ç –∞–ª—É—É
			async function loadData() {
				try {
					updateStatus("syncing", "–ñ“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...");
					const res = await fetch(API_URL);
					const data = await res.json();
					// ElchoCrud –∞–¥–∞—Ç—Ç–∞ –º–∞–∞–ª—ã–º–∞—Ç—Ç—ã —Ç“Ø–∑ –∂–µ data –∏—á–∏–Ω–¥–µ –±–µ—Ä–µ—Ç
					bookedSlots = Array.isArray(data) ? data : data.data || [];
					updateStatus("success", "‚úì –°–∏–Ω—Ö—Ä–æ–Ω–¥–æ—à—Ç—É—Ä—É–ª–¥—É");
					render();
				} catch (e) {
					updateStatus("offline", "‚ö† –ë–∞–π–ª–∞–Ω—ã—à “Ø–∑“Ø–ª–¥“Ø");
				}
			}

			// –ë—Ä–æ–Ω–¥–æ–æ (POST)
			async function confirmBooking() {
				if (!selectedSlot) return;

				const btn = document.getElementById("confirmBtn");
				btn.disabled = true;
				btn.textContent = "–°–∞–∫—Ç–∞–ª—É—É–¥–∞...";

				const payload = {
					date: selectedSlot.date,
					start: selectedSlot.hour,
					end: selectedSlot.hour + 1,
					title: "–í–æ–ª–µ–π–±–æ–ª –ë—Ä–æ–Ω", // API —Ç–∞–ª–∞–ø –∫—ã–ª—ã—à—ã –º“Ø–º–∫“Ø–Ω
				};

				try {
					const res = await fetch(API_URL, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(payload),
					});

					if (res.ok) {
						closeModal();
						await loadData();
					}
				} catch (e) {
					alert("–ö–∞—Ç–∞ –∫–µ—Ç—Ç–∏!");
				} finally {
					btn.disabled = false;
					btn.textContent = "–´—Ä–∞—Å—Ç–æ–æ";
				}
			}

			// ”®—á“Ø—Ä“Ø“Ø (DELETE)
			async function deleteBooking(id) {
				if (!confirm("–ë—É–ª –±—Ä–æ–Ω–¥–æ–æ–Ω—É ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?")) return;

				try {
					updateStatus("syncing", "”®—á“Ø—Ä“Ø–ª“Ø“Ø–¥”©...");
					const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
					if (res.ok) {
						await loadData();
					}
				} catch (e) {
					alert("”®—á“Ø—Ä“Ø“Ø–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏");
				}
			}

			// –î–∞—Ç–∞–ª–∞—Ä–¥—ã —ç—Å–µ–ø—Ç”©”©
			function getWeekDates(offset) {
				const now = new Date();
				const startOfWeek = new Date(now);
				const day = now.getDay();
				const diff = (day === 0 ? -6 : 1) - day;
				startOfWeek.setDate(now.getDate() + diff + offset * 7);

				return Array.from({ length: 7 }, (_, i) => {
					const d = new Date(startOfWeek);
					d.setDate(startOfWeek.getDate() + i);
					return d;
				});
			}

			function formatDate(d) {
				return d.toISOString().split("T")[0];
			}

			function render() {
				const dates = getWeekDates(currentWeekOffset);
				document.getElementById(
					"weekInfo"
				).textContent = `${dates[0].toLocaleDateString(
					"ky-KG"
				)} - ${dates[6].toLocaleDateString("ky-KG")}`;

				const grid = document.getElementById("daysGrid");
				grid.innerHTML = "";

				const now = new Date();

				dates.forEach((date, idx) => {
					const dateStr = formatDate(date);
					const dayCard = document.createElement("div");
					dayCard.className = "day-card";

					let slotsHtml = "";
					for (let h = 9; h < 23; h++) {
						const slotTime = new Date(date);
						slotTime.setHours(h, 0, 0);

						const isBooked = bookedSlots.find(
							(s) => s.date === dateStr && s.start === h
						);
						const isPast = slotTime < now;

						let statusClass = "available";
						let action = `onclick="openModal('${dateStr}', ${h})"`;

						if (isBooked) {
							statusClass = "booked";
							action = "";
						} else if (isPast) {
							statusClass = "past";
							action = "";
						}

						slotsHtml += `<div class="time-slot ${statusClass}" ${action}>${h}:00</div>`;
					}

					dayCard.innerHTML = `
            <div class="day-header">
              <strong>${dayNames[idx]}</strong>
              <span>${date.toLocaleDateString("ky-KG")}</span>
            </div>
            <div class="time-slots">${slotsHtml}</div>
          `;
					grid.appendChild(dayCard);
				});

				// –ë—Ä–æ–Ω–¥–æ—Ä–¥—É–Ω —Ç–∏–∑–º–µ—Å–∏–Ω —á—ã–≥–∞—Ä—É—É
				const list = document.getElementById("bookedList");
				list.innerHTML =
					bookedSlots
						.map(
							(s) => `
          <div class="booked-item">
            <div>üìÖ ${s.date} | ‚è∞ ${s.start}:00 - ${s.end}:00</div>
            <button class="cancel-btn" onclick="deleteBooking('${
							s._id || s.id
						}')">”®—á“Ø—Ä“Ø“Ø</button>
          </div>
        `
						)
						.join("") || "–ë—Ä–æ–Ω–¥–æ—Ä –∂–æ–∫";
			}

			function openModal(date, hour) {
				selectedSlot = { date, hour };
				document.getElementById(
					"modalText"
				).textContent = `${date} –∫“Ø–Ω“Ø —Å–∞–∞—Ç ${hour}:00–≥–æ –±—Ä–æ–Ω–¥–æ–π—Å—É–∑–±—É?`;
				document.getElementById("bookingModal").classList.add("active");
			}

			function closeModal() {
				document.getElementById("bookingModal").classList.remove("active");
			}

			function changeWeek(dir) {
				currentWeekOffset += dir;
				render();
			}

			// –ë–∞—à—Ç–∞–ø–∫—ã –∂“Ø–∫—Ç”©”©
			loadData();
			// –ê—Ä 30 —Å–µ–∫—É–Ω–¥–¥–∞ –∂–∞“£—ã–ª–∞–ø —Ç—É—Ä–∞—Ç
			setInterval(loadData, 30000);
		</script>
	</body>
</html>
